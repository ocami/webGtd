import db from "../repository/fireBase_repository"
import ActionsList_store from "../store/ActionsList_store"
import Control_store from "../store/Control_store"
import dateTimeTools from '../tools/DateTime.js'

var Promise = require('es6-promise').Promise;

class Action_store {
    constructor() {

        this.action = {}
        this.index = 0
        this.data = {
            action: this.action,
            index: this.index,
        }
    }

    speedAdd(content) {
        console.log('> app_store/speedAdd')

        let name = this.generateName(content)
        let action = this.newAction('receipt')
        action.name = name
        action.content = content

        ActionsList_store.getOneListByName('receipt').list.push(action)
        db.addAction(action)
    }

    switch(newListName, listName, index){
        console.log('> Action_store/switch')

        if (!listName)
            listName = ActionsList_store.data.currentList

        if (!index)
            index = this.data.index

        let list = ActionsList_store.getOneListByName(listName).list
        let newList = ActionsList_store.getOneListByName(newListName).list

        this.data.action.status = newListName
        this.setInListOn()

        newList.push(this.data.action)
        list.splice(index, 1)

        this.setCurrentByIndex(0)

        db.switch(newListName, listName, this.data.action)
    }


    setCurrentByIndex (index) {
        console.log('> Action_store/setCurrentByIndex')
        let list = ActionsList_store.data.currentList.list

        this.data.action.isActive = false

        if(!list.length){
            Control_store.data.editSeen = 'empty'
            return
        }

        this.data.action = list[index]
        this.data.action.isActive = true
        this.data.index = index
    }

    setUpdateOn() {
        console.log('> Action_store/setUpdateOn')
        let array = this.data.action.autoTags.slice()
        array[1] = new Date().getTime()
        this.data.action.autoTags = array
    }

    setInListOn() {
        console.log('> Action_store/setInListOn')
        let array = this.data.action.autoTags.slice()
        array[2] = new Date().getTime()
        this.data.action.autoTags = array
    }

    add () {

    }

    update () {

    }

    getTagByName () {

    }

    newAction(status) {
        console.log('Action_store/newAction')

        let time = new Date().getTime()
        return {
            id: this.guid(),
            name: '',
            content: '',
            dateTime: {
                date: 0,
                time: Control_store.data.options.endOfDay,
                minutes: 0,
                expiry: true,
                toString: null
            },
            status: status,
            isActive: false,
            visible: true,
            tags: [
                {name: 'project', value: null, button: false},
                {name: 'location', value: null, button: false},
                {name: 'contact', value: null, button: false},
                {name: 'tools', value: null, button: false},
                {name: 'priority', value: null, button: false},
                {name: 'duration', value: null, button: false},
                {name: 'date', value: null, button: false},
            ],
            autoTags: [time, time, time]
        }

    }

    generateName(content) {
        console.log('> app_store/generateName')
        let firstLine = content.match(/[^\r\n]+/g);
        let name = firstLine[0].substring(0, 20)

        if (name.length < firstLine[0].length)
            name = name + '...'

        return name
    }

    guid() {
        function s4() {
            return Math.floor((1 + Math.random()) * 0x10000)
                .toString(16)
                .substring(1);
        }

        return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
    }

}

export default new Action_store();


